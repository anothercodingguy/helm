services:
  # --------------------------------------------------------------------------------
  # FRONTEND (Next.js)
  # --------------------------------------------------------------------------------
  - type: web
    name: saas-frontend
    runtime: node
    repo: .
    rootDir: frontend
    buildCommand: npm install && npm run build
    startCommand: npm start
    envVars:
      - key: NEXT_PUBLIC_API_BASE_URL
        fromService:
          type: web
          name: saas-backend
          property: url

  # --------------------------------------------------------------------------------
  # BACKEND (Node/Express)
  # --------------------------------------------------------------------------------
  - type: web
    name: saas-backend
    runtime: docker
    repo: .
    rootDir: backend
    dockerfilePath: backend/Dockerfile
    envVars:
      - key: PORT
        value: 5000
      - key: DATABASE_URL
        fromDatabase:
          name: saas-db
          property: connectionString
      - key: MOLTBOT_BASE_URL
        value: http://moltbot:7000
      - key: JWT_SECRET
        generateValue: true
      - key: PHONEPE_MERCHANT_ID
        sync: false
      - key: PHONEPE_SALT_KEY
        sync: false
      - key: USE_MOCK_BOT
        value: false  # Use real (internal) service in prod
      - key: USE_MOCK_PAYMENT
        value: false

  # --------------------------------------------------------------------------------
  # MOLTBOT (Internal Agent)
  # --------------------------------------------------------------------------------
  - type: pserv
    name: moltbot
    runtime: docker
    repo: .
    rootDir: moltbot
    dockerfilePath: moltbot/Dockerfile
    envVars:
      - key: PORT
        value: 7000
      - key: ANTHROPIC_API_KEY
        sync: false

databases:
  # --------------------------------------------------------------------------------
  # MANAGED POSTGRES
  # --------------------------------------------------------------------------------
  - name: saas-db
    plan: free # or starter
    databaseName: saas_db
    user: saas_user
